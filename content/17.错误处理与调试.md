# 17. 错误处理与调试

> 理解浏览器报告的错误
> 处理错误
> 调试JS代码

## 17.1 浏览器报告的错误
展示各大浏览器打开调试界面的方法

## 17.2 错误处理   
### 7.2.1 try-catch语句    
``` js
try {
  // 可能会发生的错误
} catch {
  // 在错误发生时怎么处理
}
```

**1. finally子句**
虽然在try-catch中finally是可选的，但是一旦使用，无论如何都会执行

**2. 错误类型**   
- Error      基类型，其他错误都继承自该类型
- EvalError  使用eval()函数发生异常时被抛出
- RangeError 在超出数值响应范围时触发 var item1 = new Array(-20)
- ReferenceError  访问变量不存在
- SyntaxError     语法错误的字符串传入eval时发生
- TypeError       在变量中保存着意外的类型或者访问不存在的方法
- URIError        encodeURI和decodeURI在URI格式不正确时导致的错误

**3. 合理使用try-catch**
- 调用某个js库会有意无意抛出错误，库本身不易修改，适合使用
- 明明白白知道函数参数类型错误会导致出错，应该检查类型再往下走，而不是使用try-catch

### 17.2.2 抛出错误
try-catch匹配的还有throw操作符，用于随时抛出自定义错误
错误的类型没有要求，当遇到throw操作符代码会立即停止执行
``` js
throw 12345;
throw "hello";
throw true;
throw new Error("Something bad happened");
throw new SyntaxError("I dont't like your syntax");
```

**1. 抛出错误的时机**
建议在开发JS过程中，重点赶住函数和可能导致函数执行失败的因素，良好的错误处理机制应该可以确保代码中只有你自己抛出的错误

**2. 抛出错误与使用try-catch**
抛出与捕获错误，应该只捕获确切知道该处理的错误
- 捕获错误的目的在于避免浏览器以默认的方式处理它们
- 而抛出错误的目的在于提供错误发生具体原因的消息

### 17.2.3 错误(error)事件
任何没有通过try-catch处理错误都会触发window的error事件
- 任何浏览器中，onerror事件都不会创建event对象，但可以接收3个参数：错误消息、错误所在URL和行号
- URL是文档的位置，而行号既可以是自动嵌入JS代码，也可以是出自外部文件

``` js
window.onerror = function(message, url, line) {
  alert(message);
  return false;
}
```
通过return false可以阻止浏览器报告错误的默认行为，即函数充当了整个文档的try-catch语句

### 17.2.4 处理错误的策略

### 17.2.5 常见的错误类型
**1.类型转换错误**    
- 建议使用===和!==避免类型转换
- 注意if判断内容，在undefined、''、0都会判断为false

**2.数据类型错误**
- 合理参数判断，判断可能导致类型错误的参数
- 调用Array的方法判断参数是否为Array而非判断参数是否有对应方法

**3.通信错误**
- 发送给服务器的URL没有使用encodeURIComponent进行编码
- 在服务器响应的数据不正确时，也会发生通信错误

### 17.2.6 区分致命错误和非致命错误     
对于非致命错误，根据以下条件判断:    
- 不影响用户的主要任务
- 只影响页面的一部分
- 可以恢复
- 重复相同操作可以消除错误

本质上，非致命错误不是需要关注的问题，没有必要因此打断用户
致命错误，通常通过以下条件来确定：
- 应用程序根本无法继续运行
- 错误明显影响到了用户的主要操作
- 会导致其他连带错误

在发生致命错误时，应该立即给用户发送一条消息，告诉用户无法继续，如果刷新才行可以提供一个刷新按钮

### 17.2.7 把错误记录到服务器
开发Web应用程序过程中一种常见的做法是集中错误日志，以便查找错误

## 17.3 调试技术
### 17.3.1 将消息记录到控制台
- error
- info
- log
- warn

### 17.3.2 将消息插入到当前页面
新建一个标签用于展示调试信息

### 17.3.3 抛出错误
对于大型项目来说，自定义错误通常使用assert()函数抛出

## 17.4 常见IE错误

## 17.5 小结
错误处理对于Web程序而言至关重要，不能提前预测可能发生的错误，不能提前采取恢复策略，可能导致较差用户体验
多数浏览器在默认情况下都不会向用户报告错误，因此开发和调试期间需要启用浏览器的错误报告功能，在投入运营产品不该有这类错误
以下是几种避免浏览器响应JS错误的方法：    
- 在可能发生错误的地方使用try-catch语句，这样有机会以适当的方式对错误给出响应，而不必延用浏览器错误处理机制
- 使用window.onerror事件处理程序，这种方式可以接受try-catch不能处理的所有错误
另外，对任何Web程序都应该分析可能的错误来源，并制定处理错误的方案
- 首先，必须明确什么是致命错误，什么是非致命错误
- 其次，再分析代码，以判断最可能发生的错误，JS中常见的错误原因如下
1.类型转换
2.未充分检测数据类型
3.发送给服务器或从服务器接收到的数据有错误
